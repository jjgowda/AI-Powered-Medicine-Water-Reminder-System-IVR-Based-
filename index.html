<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MediMind - Python Backend</title>

<!-- Icons -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>

<style>
:root {
  --bg-dark: #0f172a;
  --bg-card: #1e293b;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --success: #10b981;
  --danger: #ef4444;
  --warning: #f59e0b;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --border: #334155;
}

* { box-sizing: border-box; outline: none; }

body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', system-ui, sans-serif;
  background-color: var(--bg-dark);
  background-image: radial-gradient(circle at top right, #1e293b 0%, #0f172a 100%);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
}

.app-container {
  width: 100%;
  max-width: 500px;
  min-height: 100vh;
  background: var(--bg-dark);
  position: relative;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
}

@media (min-width: 550px) {
  .app-container {
    min-height: auto;
    margin: 40px auto;
    border-radius: 20px;
    border: 1px solid var(--border);
    overflow: hidden;
    height: 90vh;
  }
}

/* --- Typography --- */
h1, h2, h3 { margin: 0; font-weight: 600; }
h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
p { margin: 0; color: var(--text-muted); font-size: 0.95rem; }

/* --- Utils --- */
.hidden { display: none !important; }
.flex-row { display: flex; gap: 10px; align-items: center; }
.flex-between { justify-content: space-between; }
.mt-4 { margin-top: 1rem; }
.mb-4 { margin-bottom: 1rem; }
.text-center { text-align: center; }

/* --- Forms & Buttons --- */
input, select {
  width: 100%;
  padding: 12px 16px;
  background: #020617;
  border: 1px solid var(--border);
  border-radius: 12px;
  color: white;
  font-size: 1rem;
  transition: border-color 0.2s;
  margin-bottom: 12px;
}

input:focus, select:focus {
  border-color: var(--primary);
}

button {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
}

button:active { transform: scale(0.98); }

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-hover); }

.btn-secondary { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); }
.btn-secondary:hover { background: #334155; }

.btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
.btn-danger:hover { background: rgba(239, 68, 68, 0.3); }

.btn-sm { padding: 6px 12px; font-size: 0.85rem; border-radius: 8px; width: auto; }

.fab {
  position: absolute;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
}

/* --- Views --- */
.view {
  padding: 24px;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Auth View */
.auth-header {
  text-align: center;
  margin-bottom: 2rem;
  margin-top: 2rem;
}
.auth-logo { font-size: 3rem; color: var(--primary); margin-bottom: 1rem; }

/* Dashboard */
.dash-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}

.stats-card {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border-radius: 16px;
  padding: 20px;
  color: white;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.stat-item h3 { font-size: 2rem; margin-bottom: 4px; }
.stat-item p { font-size: 0.9rem; opacity: 0.9; }

/* Reminder List */
.section-title {
  color: var(--text-muted);
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 12px;
}

.reminder-list { display: flex; flex-direction: column; gap: 12px; }

.reminder-card {
  background: var(--bg-card);
  padding: 16px;
  border-radius: 12px;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 16px;
  transition: transform 0.2s;
}

.reminder-card:hover { transform: translateY(-2px); border-color: var(--primary); }

.icon-box {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}
.icon-med { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
.icon-water { background: rgba(16, 185, 129, 0.15); color: var(--success); }

.card-info { flex: 1; }
.card-info h4 { margin: 0 0 4px 0; font-size: 1rem; }
.card-info span { font-size: 0.85rem; color: var(--text-muted); display: block; }

.check-btn {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--border);
  background: transparent;
  color: transparent;
  padding: 0;
  cursor: pointer;
}
.check-btn:hover { border-color: var(--success); color: var(--success); }

/* Taken State Styles */
.reminder-card.taken { opacity: 0.7; border-color: var(--success); }
.reminder-card.taken .check-btn {
  background: var(--success);
  border-color: var(--success);
  color: white;
  cursor: default;
}

/* History List */
.history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border);
  font-size: 0.9rem;
}
.history-item:last-child { border-bottom: none; }
.history-time { color: var(--text-muted); font-size: 0.8rem; }
.history-status { font-weight: 600; }
.status-taken { color: var(--success); }
.status-skipped { color: var(--danger); }

/* Modal */
.modal-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(15, 23, 42, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 50;
  padding: 20px;
  backdrop-filter: blur(4px);
}
.modal-content {
  background: var(--bg-card);
  width: 100%;
  padding: 24px;
  border-radius: 16px;
  border: 1px solid var(--border);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Notification Toast */
.toast {
  position: absolute;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-card);
  border: 1px solid var(--primary);
  padding: 12px 20px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 100;
  animation: dropIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes dropIn { from {top: -50px;} to {top: 20px;} }

.loader {
  border: 3px solid rgba(255,255,255,0.1);
  border-left-color: var(--primary);
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: none;
  margin: 0 auto;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

</style>
</head>
<body>

<div class="app-container">

  <!-- LOADER -->
  <div id="globalLoader" style="position:absolute; inset:0; background:var(--bg-dark); z-index:200; display:flex; justify-content:center; align-items:center;">
    <div class="loader" style="display:block; width:40px; height:40px;"></div>
  </div>

  <!-- AUTH VIEW -->
  <div id="authView" class="view hidden">
    <div class="auth-header">
      <i class="ph-fill ph-pill auth-logo"></i>
      <h1 class="mb-4">MediMind</h1>
      <p>Python Backend Edition</p>
    </div>

    <div id="authForm">
      <div id="registerFields" class="hidden">
        <input id="authName" type="text" placeholder="Full Name">
        <select id="authLang">
          <option value="en">English Voice</option>
          <option value="kn">Kannada (ಕನ್ನಡ)</option>
        </select>
      </div>
      
      <input id="authPhone" type="tel" placeholder="Phone Number (e.g. 9876543210)">
      <input id="authPass" type="password" placeholder="Password">
      
      <button onclick="handleAuth()" class="btn-primary" id="authBtn">
        <span id="authBtnText">Login</span>
        <div class="loader" id="authLoader"></div>
      </button>

      <p class="text-center mt-4" style="cursor:pointer; color:var(--primary);" onclick="toggleAuthMode()">
        <span id="authToggleText">New user? Create account</span>
      </p>
    </div>
  </div>

  <!-- DASHBOARD VIEW -->
  <div id="dashView" class="view hidden">
    <div class="dash-header">
      <div>
        <h2 id="greeting">Hello!</h2>
        <p id="dateDisplay">Loading date...</p>
      </div>
      <button class="btn-secondary btn-sm" onclick="logout()">
        <i class="ph ph-sign-out"></i>
      </button>
    </div>

    <div class="stats-card">
      <div class="stat-item">
        <h3 id="adherenceRate">--%</h3>
        <p>Today's Adherence</p>
      </div>
      <i class="ph-duotone ph-chart-pie-slice" style="font-size: 48px; opacity:0.8;"></i>
    </div>

    <div class="flex-between" style="margin-bottom:12px;">
      <div class="section-title">Today's Schedule</div>
    </div>

    <div id="reminderList" class="reminder-list">
      <p class="text-center" style="padding:20px;">Loading...</p>
    </div>

    <div class="flex-between" style="margin-bottom:12px; margin-top:24px;">
      <div class="section-title">History Log</div>
    </div>
    
    <div id="historyList" class="reminder-list" style="max-height: 200px; overflow-y: auto;">
        <!-- History items go here -->
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="openModal()">
      <i class="ph ph-plus"></i>
    </button>
  </div>

  <!-- ADD/EDIT MODAL -->
  <div id="addModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="flex-between mb-4">
        <h2 id="modalTitle">Add Reminder</h2>
        <button class="btn-secondary btn-sm" onclick="closeModal()" style="width:auto"><i class="ph ph-x"></i></button>
      </div>

      <input type="hidden" id="editId">
      <label style="font-size:0.9rem; color:var(--text-muted); margin-bottom:4px; display:block;">Medicine Name</label>
      <input id="newMedName" placeholder="e.g. Paracetamol">

      <div class="flex-row">
        <div style="flex:1">
           <label style="font-size:0.9rem; color:var(--text-muted); margin-bottom:4px; display:block;">Time</label>
           <input id="newMedTime" type="time">
        </div>
        <div style="flex:1">
           <label style="font-size:0.9rem; color:var(--text-muted); margin-bottom:4px; display:block;">Dosage</label>
           <input id="newMedDose" placeholder="e.g. 1 Tablet">
        </div>
      </div>

      <button id="saveBtn" class="btn-primary mt-4" onclick="saveMedicine()">Save Medicine</button>
      <button id="waterBtn" class="btn-secondary mt-4" onclick="addWaterReminder()">Add Water Reminder (120 mins)</button>
    </div>
  </div>

  <!-- TOAST NOTIFICATION -->
  <div id="toast" class="toast hidden">
    <i class="ph-fill ph-check-circle" style="color:var(--success)"></i>
    <span id="toastMsg">Action Successful</span>
  </div>

</div>

<script>
/* --------------------------------------------------------------
   CONFIG & STATE
   -------------------------------------------------------------- 
*/
const API_BASE = ""; 

let currentUser = null;
let authToken = null;
let reminders = [];
let adherenceLogs = []; // Store backend logs here
let authMode = "login";

// Initialize
function init() {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');
    
    document.getElementById('globalLoader').style.display = 'none';

    if (token && userStr) {
        authToken = token;
        currentUser = JSON.parse(userStr);
        loadDashboard();
    } else {
        showAuth();
    }

    const options = { weekday: 'long', month: 'short', day: 'numeric' };
    document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', options);
    
    setInterval(refreshData, 30000); 
}

/* --------------------------------------------------------------
   API HELPERS
   -------------------------------------------------------------- 
*/
async function apiCall(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    if (authToken) headers['Authorization'] = authToken;

    const options = { method, headers };
    if (body) options.body = JSON.stringify(body);

    try {
        const res = await fetch(`${API_BASE}${endpoint}`, options);
        if (res.status === 401) { logout(); return null; }
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || data.error || "Request failed");
        return data;
    } catch (err) {
        console.error("API Error:", err);
        return null;
    }
}

/* --------------------------------------------------------------
   AUTH LOGIC
   -------------------------------------------------------------- 
*/
function showAuth() {
    document.getElementById('authView').classList.remove('hidden');
    document.getElementById('dashView').classList.add('hidden');
}

function toggleAuthMode() {
    authMode = authMode === "login" ? "register" : "login";
    const isReg = authMode === "register";
    document.getElementById('registerFields').classList.toggle('hidden', !isReg);
    document.getElementById('authBtnText').innerText = isReg ? "Create Account" : "Login";
    document.getElementById('authToggleText').innerText = isReg ? "Have an account? Login" : "New user? Create account";
}

async function handleAuth() {
    const phone = document.getElementById('authPhone').value;
    const pass = document.getElementById('authPass').value;
    const name = document.getElementById('authName').value;
    const lang = document.getElementById('authLang').value;
    const loader = document.getElementById('authLoader');
    const btnText = document.getElementById('authBtnText');

    if(!phone || !pass) return showToast("Please fill all fields");

    loader.style.display = 'block';
    btnText.style.display = 'none';

    let result;
    if (authMode === "register") {
        result = await apiCall('/register', 'POST', { name, phone, password: pass, language: lang });
        if (result) {
            showToast("Registered! Please login.");
            toggleAuthMode(); 
        } else {
            showToast("Registration failed");
        }
    } else {
        result = await apiCall('/login', 'POST', { phone, password: pass });
        if (result && result.token) {
            authToken = result.token;
            currentUser = result.user;
            localStorage.setItem('token', authToken);
            localStorage.setItem('user', JSON.stringify(currentUser));
            loadDashboard();
        } else {
            showToast("Login failed");
        }
    }

    loader.style.display = 'none';
    btnText.style.display = 'block';
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.clear();
    location.reload();
}

/* --------------------------------------------------------------
   DASHBOARD LOGIC
   -------------------------------------------------------------- 
*/
async function loadDashboard() {
    document.getElementById('authView').classList.add('hidden');
    document.getElementById('dashView').classList.remove('hidden');
    document.getElementById('greeting').innerText = `Hello, ${currentUser.name}!`;
    await refreshData();
}

async function refreshData() {
    const remData = await apiCall('/my-reminders');
    if (remData) reminders = remData;

    const adhData = await apiCall('/my-adherence');
    if (adhData) adherenceLogs = adhData;

    renderReminders();
    renderHistory();
    calculateAdherence();
}

function calculateAdherence() {
    if (reminders.length > 0) {
        const todayStr = new Date().toDateString(); // Local date string "Sat Jan 17 2026"
        
        // Robust check: Compare calendar dates
        const uniqueTakenIds = new Set();
        adherenceLogs.forEach(log => {
             if (new Date(log.time).toDateString() === todayStr && log.status === 'taken') {
                 uniqueTakenIds.add(log.reminder_id);
             }
        });
        
        const percentage = Math.round((uniqueTakenIds.size / reminders.length) * 100);
        const safePerc = isNaN(percentage) ? 0 : Math.min(percentage, 100);
        document.getElementById('adherenceRate').innerText = `${safePerc}%`;
    } else {
        document.getElementById('adherenceRate').innerText = "0%";
    }
}

function renderReminders() {
    const list = document.getElementById('reminderList');
    list.innerHTML = '';

    reminders.sort((a,b) => {
        if (a.schedule_time && b.schedule_time) return a.schedule_time.localeCompare(b.schedule_time);
        return 0;
    });

    if(reminders.length === 0) {
        list.innerHTML = `<p class="text-center" style="padding:20px;">No reminders found.</p>`;
        return;
    }

    const todayStr = new Date().toDateString();
    
    reminders.forEach(r => {
        const isMedicine = r.type === 'medicine';
        const iconClass = isMedicine ? 'ph-pill' : 'ph-drop';
        const bgClass = isMedicine ? 'icon-med' : 'icon-water';
        const displayTime = isMedicine ? convertTo12Hour(r.schedule_time) : `Every ${r.interval_minutes} mins`;
        const subText = isMedicine ? r.dosage : 'Hydration';

        // IMPROVED MATCHING: Compare Date Strings to ignore Time/Timezone issues
        const isTaken = adherenceLogs.some(log => 
            log.reminder_id === r.id && 
            new Date(log.time).toDateString() === todayStr && 
            log.status === 'taken'
        );

        const div = document.createElement('div');
        div.className = `reminder-card ${isTaken ? 'taken' : ''}`;
        
        let actionHtml = '';
        if (isTaken) {
            actionHtml = `
                <button class="check-btn" disabled>
                    <i class="ph-bold ph-check"></i>
                </button>`;
        } else {
            actionHtml = `
                <button class="check-btn" onclick="markTaken('${r.id}')">
                    <i class="ph-bold ph-check" style="opacity:0.3"></i>
                </button>
                <div style="display:flex; flex-direction:column; gap:4px; margin-left:8px;">
                    <button class="btn-secondary btn-sm" onclick="editReminder('${r.id}')" style="padding:6px; background:transparent; border:none; color:var(--primary);">
                        <i class="ph-fill ph-pencil-simple" style="font-size:18px;"></i>
                    </button>
                    <button class="btn-danger btn-sm" onclick="deleteReminder('${r.id}')" style="padding:6px; background:transparent; border:none;">
                        <i class="ph ph-trash" style="font-size:18px;"></i>
                    </button>
                </div>`;
        }

        div.innerHTML = `
            <div class="icon-box ${bgClass}">
                <i class="ph-fill ${iconClass}"></i>
            </div>
            <div class="card-info">
                <h4>${r.name || 'Water'}</h4>
                <span>${displayTime} • ${subText}</span>
            </div>
            ${actionHtml}
        `;
        list.appendChild(div);
    });
}

function renderHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    
    if (adherenceLogs.length === 0) {
        list.innerHTML = `<p class="text-center" style="padding:10px; font-size:0.85rem;">No history yet.</p>`;
        return;
    }

    // Sort by time desc
    const sortedLogs = [...adherenceLogs].sort((a,b) => new Date(b.time) - new Date(a.time));

    sortedLogs.forEach(log => {
        // Find reminder name if possible, else generic
        const reminder = reminders.find(r => r.id === log.reminder_id);
        const name = reminder ? (reminder.name || 'Water') : (log.type === 'water' ? 'Water' : 'Unknown Medicine');
        
        const dateObj = new Date(log.time);
        const timeStr = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const dateStr = dateObj.toDateString() === new Date().toDateString() ? "Today" : dateObj.toLocaleDateString();

        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <div>
                <div style="font-weight:500;">${name}</div>
                <div class="history-time">${dateStr}, ${timeStr}</div>
            </div>
            <div class="history-status ${log.status === 'taken' ? 'status-taken' : 'status-skipped'}">
                ${log.status.toUpperCase()}
            </div>
        `;
        list.appendChild(div);
    });
}

/* --------------------------------------------------------------
   MODAL & EDIT LOGIC
   -------------------------------------------------------------- 
*/
function openModal(data = null) {
    const modal = document.getElementById('addModal');
    const title = document.getElementById('modalTitle');
    const saveBtn = document.getElementById('saveBtn');
    const waterBtn = document.getElementById('waterBtn');

    if (data) {
        // EDIT MODE
        title.innerText = "Edit Reminder";
        document.getElementById('editId').value = data.id;
        document.getElementById('newMedName').value = data.name;
        document.getElementById('newMedTime').value = data.schedule_time;
        document.getElementById('newMedDose').value = data.dosage;
        saveBtn.innerText = "Update Reminder";
        saveBtn.onclick = () => saveMedicine(true); // true = update
        waterBtn.style.display = 'none'; // Can't edit to water here
    } else {
        // ADD MODE
        title.innerText = "Add Reminder";
        document.getElementById('editId').value = "";
        document.getElementById('newMedName').value = "";
        document.getElementById('newMedTime').value = "";
        document.getElementById('newMedDose').value = "";
        saveBtn.innerText = "Save Medicine";
        saveBtn.onclick = () => saveMedicine(false); // false = create
        waterBtn.style.display = 'block';
    }
    
    modal.classList.remove('hidden');
}

function closeModal() {
    document.getElementById('addModal').classList.add('hidden');
}

function editReminder(id) {
    const r = reminders.find(item => item.id === id);
    if(r) openModal(r);
}

async function saveMedicine(isUpdate) {
    const id = document.getElementById('editId').value;
    const name = document.getElementById('newMedName').value;
    const time = document.getElementById('newMedTime').value;
    const dose = document.getElementById('newMedDose').value;

    if(!name || !time) return showToast("Name and Time required");

    let res;
    if (isUpdate) {
        // CALL UPDATE ENDPOINT
        res = await apiCall(`/update-reminder/${id}`, 'PUT', {
            dosage: dose,
            schedule_time: time
        });
    } else {
        // CALL CREATE ENDPOINT
        res = await apiCall('/add-medicine', 'POST', {
            name, 
            schedule_time: time, 
            dosage: dose
        });
    }

    if (res && res.ok) {
        closeModal();
        showToast(isUpdate ? "Updated Successfully" : "Added Successfully");
        refreshData();
    }
}

async function addWaterReminder() {
    const res = await apiCall('/add-water-reminder', 'POST', {
        interval_minutes: 120
    });

    if (res && res.ok) {
        closeModal();
        showToast("Water Reminder Added");
        refreshData();
    }
}

async function markTaken(id) {
    const res = await apiCall(`/mark-taken/${id}`, 'POST');
    if (res && res.ok) {
        showToast("Marked as taken!");
        refreshData();
    }
}

async function deleteReminder(id) {
    if(!confirm("Delete this reminder?")) return;
    const res = await apiCall(`/delete-reminder/${id}`, 'DELETE');
    if (res && res.ok) {
        refreshData();
        showToast("Deleted");
    }
}

/* --------------------------------------------------------------
   UTILS
   -------------------------------------------------------------- 
*/
function convertTo12Hour(timeStr) {
    if(!timeStr) return '';
    const [hours, mins] = timeStr.split(':');
    const h = parseInt(hours);
    const ampm = h >= 12 ? 'PM' : 'AM';
    const h12 = h % 12 || 12;
    return `${h12}:${mins} ${ampm}`;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').innerText = msg;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 3000);
}

// Init
init();

</script>
</body>
</html>